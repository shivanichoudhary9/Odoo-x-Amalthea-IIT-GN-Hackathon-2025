<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ExpenseFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .sidebar { height: 100vh; }
        .tab-content { min-height: 80vh; }
        .modal-overlay { background-color: rgba(0,0,0,0.5); }
    </style>
</head>
<body class="font-sans bg-gray-50">

    <div id="app">
        <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
            <h1 class="text-2xl font-bold text-purple-700">ExpenseFlow Admin Panel</h1>
            <div class="flex items-center space-x-4">
                <div id="admin-info" class="text-sm text-gray-600">Admin User</div>
                <a href="#" id="logout-button" class="text-sm text-red-500 hover:text-red-700 font-medium transition">Logout</a>
            </div>
        </header>
        
        <div class="flex">
            <nav id="sidebar" class="w-64 bg-gray-800 p-4 text-white sticky top-0 sidebar">
                <button onclick="setActiveTab('users')" id="tab-users" class="w-full text-left p-3 rounded-lg flex items-center transition bg-purple-600">User Management</button>
                <button onclick="setActiveTab('expenses')" id="tab-expenses" class="mt-2 w-full text-left p-3 rounded-lg flex items-center transition hover:bg-gray-700">View All Expenses</button>
            </nav>
            <main class="flex-1 p-8">
                <div id="content">
                    <div id="tab-content-users" class="tab-content-item bg-white shadow-xl rounded-2xl p-4">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">User Management</h2>
                        <button id="create-user-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition flex items-center mb-6">Create User</button>
                        <div class="shadow-lg rounded-xl overflow-hidden border border-gray-100">
                            <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User Email</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Manager</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th></tr></thead><tbody id="user-table-body" class="bg-white divide-y divide-gray-200"></tbody></table>
                        </div>
                    </div>
                    <div id="tab-content-expenses" class="tab-content-item bg-white shadow-xl rounded-2xl p-4 hidden">
                        <h2 class="text-xl font-semibold mb-4 text-gray-700">All Company Expenses</h2>
                        <div class="shadow-lg rounded-xl overflow-hidden border border-gray-100">
                            <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Employee</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Category</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Amount</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Override</th></tr></thead><tbody id="expenses-table-body" class="bg-white divide-y divide-gray-200"></tbody></table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="create-modal" class="modal-overlay fixed inset-0 z-30 flex items-center justify-center hidden"><div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md"><h3 class="text-xl font-semibold mb-4">Create New User</h3><form id="create-form"><div class="space-y-4"><input type="email" name="email" placeholder="Email Address" required class="w-full p-2 border rounded"><input type="password" name="password" placeholder="Password" required class="w-full p-2 border rounded"><select name="role" required class="w-full p-2 border rounded"><option value="Employee">Employee</option><option value="Manager">Manager</option><option value="CFO">CFO</option></select></div><div id="create-error" class="text-red-500 text-sm mt-2"></div><div class="mt-6 flex justify-end space-x-4"><button type="button" id="create-cancel-btn" class="px-4 py-2 bg-gray-200 rounded">Cancel</button><button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded">Create</button></div></form></div></div>
    <div id="edit-modal" class="modal-overlay fixed inset-0 z-30 flex items-center justify-center hidden"><div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md"><h3 class="text-xl font-semibold mb-4">Edit User</h3><form id="edit-form"><input type="hidden" name="user_id"><div class="space-y-4"><input type="email" name="email" disabled class="w-full p-2 border rounded bg-gray-100"><select name="role" required class="w-full p-2 border rounded"><option value="Employee">Employee</option><option value="Manager">Manager</option><option value="CFO">CFO</option></select><select name="manager_id" class="w-full p-2 border rounded"></select></div><div id="edit-error" class="text-red-500 text-sm mt-2"></div><div class="mt-6 flex justify-end space-x-4"><button type="button" id="edit-cancel-btn" class="px-4 py-2 bg-gray-200 rounded">Cancel</button><button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded">Save Changes</button></div></form></div></div>

<script>
    const token = localStorage.getItem('accessToken');
    const API_BASE_URL = 'http://127.0.0.1:5000/api';
    let allUsers = [];

    // --- (Modal helpers and API helper are the same as before) ---
    const createModal = document.getElementById('create-modal');
    const editModal = document.getElementById('edit-modal');
    const showCreateModal = () => createModal.classList.remove('hidden');
    const hideCreateModal = () => { createModal.classList.add('hidden'); document.getElementById('create-form').reset(); document.getElementById('create-error').textContent = ''; };
    const showEditModal = () => editModal.classList.remove('hidden');
    const hideEditModal = () => { editModal.classList.add('hidden'); document.getElementById('edit-form').reset(); document.getElementById('edit-error').textContent = ''; };
    async function apiRequest(endpoint, method, body = null) {
        const headers = { 'Authorization': `Bearer ${token}` };
        if (body) headers['Content-Type'] = 'application/json';
        const response = await fetch(`${API_BASE_URL}${endpoint}`, { method, headers, body: body ? JSON.stringify(body) : null });
        if (response.status === 401) {
            localStorage.clear();
            window.location.href = 'login.html';
        }
        return response;
    }

    // --- RENDER FUNCTIONS ---
    function renderUserTable(users) {
        const userTableBody = document.getElementById('user-table-body');
        userTableBody.innerHTML = '';
        const managers = users.filter(u => u.role === 'Manager');

        users.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `<td class="px-6 py-4 text-sm font-medium text-gray-900">${user.email}</td><td class="px-6 py-4 text-sm text-gray-700">${user.role}</td><td class="px-6 py-4 text-sm text-gray-500">${(managers.find(m => m.id === user.manager_id) || {}).email || 'N/A'}</td><td class="px-6 py-4 text-right text-sm font-medium space-x-2"><button class="edit-btn text-indigo-600" data-id="${user.id}">Edit</button><button class="delete-btn text-red-600" data-id="${user.id}">Delete</button></td>`;
            userTableBody.appendChild(row);
        });
    }

    function renderAllExpenses(expenses) {
        const expensesTableBody = document.getElementById('expenses-table-body');
        expensesTableBody.innerHTML = '';
        if (expenses.length === 0) {
            expensesTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4">No expenses found in the company.</td></tr>`;
            return;
        }
        expenses.forEach(exp => {
            const row = document.createElement('tr');
            const isPending = exp.status.toLowerCase().includes('pending');
            row.innerHTML = `
                <td class="px-6 py-4 text-sm text-gray-900">${exp.employee_email}</td>
                <td class="px-6 py-4 text-sm text-gray-700">${exp.category}</td>
                <td class="px-6 py-4 text-sm text-right text-gray-900">${exp.amount} ${exp.currency}</td>
                <td class="px-6 py-4 text-sm text-gray-700">${exp.status}</td>
                <td class="px-6 py-4 text-right text-sm font-medium space-x-2">
                    ${isPending ? `<button class="override-btn text-green-600" data-id="${exp.expense_id}" data-action="approve">Approve</button>
                                  <button class="override-btn text-red-600" data-id="${exp.expense_id}" data-action="reject">Reject</button>` : 'N/A'}
                </td>
            `;
            expensesTableBody.appendChild(row);
        });
    }

    // --- DATA REFRESH FUNCTIONS ---
    async function refreshUsers() {
        try {
            const response = await apiRequest('/users', 'GET');
            allUsers = await response.json();
            renderUserTable(allUsers);
        } catch (error) { console.error("Failed to refresh users:", error); }
    }

    async function refreshAllExpenses() {
        try {
            const response = await apiRequest('/expenses/all', 'GET');
            const expenses = await response.json();
            renderAllExpenses(expenses);
        } catch (e) { console.error('Failed to fetch all expenses:', e); }
    }

    // --- TAB SWITCHING ---
    function setActiveTab(tabName) {
        document.querySelectorAll('#sidebar button').forEach(btn => btn.classList.remove('bg-purple-600'));
        document.querySelectorAll('.tab-content-item').forEach(el => el.classList.add('hidden'));
        
        document.getElementById(`tab-${tabName}`).classList.add('bg-purple-600');
        document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');

        if (tabName === 'users') {
            refreshUsers();
        } else if (tabName === 'expenses') {
            refreshAllExpenses();
        }
    }

    // --- EVENT LISTENERS (RUNS ONCE) ---
    function setupEventListeners() {
        document.getElementById('create-user-btn').addEventListener('click', showCreateModal);
        document.getElementById('create-cancel-btn').addEventListener('click', hideCreateModal);
        document.getElementById('create-form').addEventListener('submit', async e => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target).entries());
            const response = await apiRequest('/users', 'POST', data);
            if (response.ok) { hideCreateModal(); refreshUsers(); }
            else { document.getElementById('create-error').textContent = (await response.json()).message; }
        });

        document.getElementById('user-table-body').addEventListener('click', async e => {
            if (!e.target.dataset.id) return;
            const userId = e.target.dataset.id;
            if (e.target.classList.contains('delete-btn')) {
                if (confirm('Are you sure you want to delete this user?')) {
                    const response = await apiRequest(`/users/${userId}`, 'DELETE');
                    if (response.ok) refreshUsers(); else alert('Failed to delete user.');
                }
            }
            if (e.target.classList.contains('edit-btn')) {
                const userToEdit = allUsers.find(u => u.id == userId);
                if (!userToEdit) return;
                const form = document.getElementById('edit-form');
                form.user_id.value = userToEdit.id;
                form.email.value = userToEdit.email;
                form.role.value = userToEdit.role;
                const managerSelect = form.manager_id;
                managerSelect.innerHTML = '<option value="">No Manager</option>';
                allUsers.filter(u => u.role === 'Manager' && u.id != userId).forEach(m => {
                    managerSelect.innerHTML += `<option value="${m.id}" ${m.id === userToEdit.manager_id ? 'selected' : ''}>${m.email}</option>`;
                });
                showEditModal();
            }
        });

        document.getElementById('edit-cancel-btn').addEventListener('click', hideEditModal);
        document.getElementById('edit-form').addEventListener('submit', async e => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = { role: formData.get('role'), manager_id: formData.get('manager_id') || null };
            const response = await apiRequest(`/users/${formData.get('user_id')}`, 'PUT', data);
            if (response.ok) { hideEditModal(); refreshUsers(); }
            else { document.getElementById('edit-error').textContent = (await response.json()).message; }
        });

        document.getElementById('logout-button').addEventListener('click', e => {
            e.preventDefault();
            localStorage.clear();
            window.location.href = 'login.html';
        });

        document.getElementById('expenses-table-body').addEventListener('click', async (e) => {
            if (e.target.classList.contains('override-btn')) {
                const { id, action } = e.target.dataset;
                if (confirm(`Are you sure you want to override and ${action} this expense?`)) {
                    const response = await apiRequest(`/expenses/${id}/override`, 'POST', { action });
                    if (response.ok) refreshAllExpenses(); else alert('Override failed.');
                }
            }
        });
    }

    // --- INITIAL PAGE LOAD ---
    document.addEventListener('DOMContentLoaded', () => {
        if (!token) { window.location.href = 'login.html'; return; }
        document.getElementById('admin-info').textContent = `Admin User`;
        setupEventListeners();
        setActiveTab('users');
    });
</script>
</body>
</html>